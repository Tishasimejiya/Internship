name: Deploy Multi-Instance (Smart Cleanup)

on:
  push:
    branches:
      - main
    paths:
      - 'Streamlit_app/**'
      - '.github/workflows/deploy.yml'

jobs:
  # Pre-deployment cleanup
  cleanup:
    runs-on: self-hosted
    steps:
      - name: Smart cleanup - Stop ALL related containers
        run: |
          echo "ğŸ§¹ Starting smart cleanup..."
          echo ""
          
          # Find and stop ALL containers with 'registration' in name
          echo "ğŸ” Finding all registration containers..."
          CONTAINERS=$(docker ps -a --filter "name=registration" --format "{{.Names}}" | tr '\n' ' ')
          
          if [ -z "$CONTAINERS" ]; then
            echo "âœ… No old containers found. Clean slate!"
          else
            echo "Found containers: $CONTAINERS"
            echo "ğŸ›‘ Stopping and removing..."
            
            for container in $CONTAINERS; do
              echo "  - Stopping $container..."
              docker stop $container || true
              echo "  - Removing $container..."
              docker rm $container || true
            done
            
            echo "âœ… All old containers cleaned up"
          fi
          echo ""
          
      - name: Check port availability
        run: |
          echo "ğŸ” Checking port availability..."
          echo ""
          
          for port in 8501 8502 8503 8504 8505; do
            if lsof -Pi :$port -sTCP:LISTEN -t >/dev/null 2>&1 ; then
              echo "âš ï¸  Port $port is in use"
              PID=$(lsof -Pi :$port -sTCP:LISTEN -t)
              echo "   Process ID: $PID"
              # Don't kill it - Docker cleanup above should have handled it
            else
              echo "âœ… Port $port is available"
            fi
          done
          echo ""
          
      - name: Cleanup old images (optional)
        run: |
          echo "ğŸ§¹ Cleaning up old dangling images..."
          docker image prune -f || true
          echo "âœ… Cleanup complete"

  # Deploy Instance 1
  deploy-instance-1:
    runs-on: self-hosted
    needs: cleanup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run validation tests
        working-directory: ./Streamlit_app
        run: |
          python3 tests/test_validation.py
      
      - name: Build image for Instance 1
        working-directory: ./Streamlit_app
        run: |
          echo "ğŸ”¨ Building registration-app:instance-1..."
          docker build -t registration-app:instance-1 .
      
      - name: Deploy Instance 1
        run: |
          echo "ğŸš€ Starting registration-instance-1 on port 8501..."
          docker run -d \
            -p 8501:8501 \
            --name registration-instance-1 \
            --restart unless-stopped \
            registration-app:instance-1
          
          sleep 3
          
          if docker ps | grep -q registration-instance-1; then
            echo "âœ… Instance 1 started successfully"
          else
            echo "âŒ Instance 1 failed to start"
            docker logs registration-instance-1
            exit 1
          fi
      
      - name: Health check Instance 1
        run: |
          echo "ğŸ¥ Health checking port 8501..."
          sleep 5
          curl -f http://localhost:8501 || exit 1
          echo "âœ… Instance 1 healthy"

  # Deploy Instance 2
  deploy-instance-2:
    runs-on: self-hosted
    needs: cleanup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Build image for Instance 2
        working-directory: ./Streamlit_app
        run: |
          echo "ğŸ”¨ Building registration-app:instance-2..."
          docker build -t registration-app:instance-2 .
      
      - name: Deploy Instance 2
        run: |
          echo "ğŸš€ Starting registration-instance-2 on port 8502..."
          docker run -d \
            -p 8502:8501 \
            --name registration-instance-2 \
            --restart unless-stopped \
            registration-app:instance-2
          
          sleep 3
          
          if docker ps | grep -q registration-instance-2; then
            echo "âœ… Instance 2 started successfully"
          else
            echo "âŒ Instance 2 failed to start"
            docker logs registration-instance-2
            exit 1
          fi
      
      - name: Health check Instance 2
        run: |
          echo "ğŸ¥ Health checking port 8502..."
          sleep 5
          curl -f http://localhost:8502 || exit 1
          echo "âœ… Instance 2 healthy"

  # Deploy Instance 3
  deploy-instance-3:
    runs-on: self-hosted
    needs: cleanup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Build image for Instance 3
        working-directory: ./Streamlit_app
        run: |
          echo "ğŸ”¨ Building registration-app:instance-3..."
          docker build -t registration-app:instance-3 .
      
      - name: Deploy Instance 3
        run: |
          echo "ğŸš€ Starting registration-instance-3 on port 8503..."
          docker run -d \
            -p 8503:8501 \
            --name registration-instance-3 \
            --restart unless-stopped \
            registration-app:instance-3
          
          sleep 3
          
          if docker ps | grep -q registration-instance-3; then
            echo "âœ… Instance 3 started successfully"
          else
            echo "âŒ Instance 3 failed to start"
            docker logs registration-instance-3
            exit 1
          fi
      
      - name: Health check Instance 3
        run: |
          echo "ğŸ¥ Health checking port 8503..."
          sleep 5
          curl -f http://localhost:8503 || exit 1
          echo "âœ… Instance 3 healthy"

  # Deploy Instance 4
  deploy-instance-4:
    runs-on: self-hosted
    needs: cleanup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Build image for Instance 4
        working-directory: ./Streamlit_app
        run: |
          echo "ğŸ”¨ Building registration-app:instance-4..."
          docker build -t registration-app:instance-4 .
      
      - name: Deploy Instance 4
        run: |
          echo "ğŸš€ Starting registration-instance-4 on port 8504..."
          docker run -d \
            -p 8504:8501 \
            --name registration-instance-4 \
            --restart unless-stopped \
            registration-app:instance-4
          
          sleep 3
          
          if docker ps | grep -q registration-instance-4; then
            echo "âœ… Instance 4 started successfully"
          else
            echo "âŒ Instance 4 failed to start"
            docker logs registration-instance-4
            exit 1
          fi
      
      - name: Health check Instance 4
        run: |
          echo "ğŸ¥ Health checking port 8504..."
          sleep 5
          curl -f http://localhost:8504 || exit 1
          echo "âœ… Instance 4 healthy"

  # Deploy Instance 5
  deploy-instance-5:
    runs-on: self-hosted
    needs: cleanup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Build image for Instance 5
        working-directory: ./Streamlit_app
        run: |
          echo "ğŸ”¨ Building registration-app:instance-5..."
          docker build -t registration-app:instance-5 .
      
      - name: Deploy Instance 5
        run: |
          echo "ğŸš€ Starting registration-instance-5 on port 8505..."
          docker run -d \
            -p 8505:8501 \
            --name registration-instance-5 \
            --restart unless-stopped \
            registration-app:instance-5
          
          sleep 3
          
          if docker ps | grep -q registration-instance-5; then
            echo "âœ… Instance 5 started successfully"
          else
            echo "âŒ Instance 5 failed to start"
            docker logs registration-instance-5
            exit 1
          fi
      
      - name: Health check Instance 5
        run: |
          echo "ğŸ¥ Health checking port 8505..."
          sleep 5
          curl -f http://localhost:8505 || exit 1
          echo "âœ… Instance 5 healthy"

  # Deployment Summary
  deployment-summary:
    runs-on: self-hosted
    needs: [deploy-instance-1, deploy-instance-2, deploy-instance-3, deploy-instance-4, deploy-instance-5]
    steps:
      - name: Display deployment summary
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… ALL 5 INSTANCES DEPLOYED SUCCESSFULLY!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ³ Docker Images:"
          docker images | grep registration-app | head -n 10
          echo ""
          echo "ğŸ“¦ Running Containers:"
          docker ps --filter name=registration-instance --format "table {{.Names}}\t{{.Image}}\t{{.Status}}\t{{.Ports}}"
          echo ""
          echo "ğŸŒ Access URLs:"
          echo "   Instance 1: http://207.180.253.183:8501"
          echo "   Instance 2: http://207.180.253.183:8502"
          echo "   Instance 3: http://207.180.253.183:8503"
          echo "   Instance 4: http://207.180.253.183:8504"
          echo "   Instance 5: http://207.180.253.183:8505"
          echo ""
          echo "â±ï¸  Deployment completed at: $(date)"
