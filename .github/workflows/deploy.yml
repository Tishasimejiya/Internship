name: Deploy Multi-Instance (Single Image)

on:
  push:
    branches:
      - main
    paths:
      - 'Streamlit_app/**'
      - '.github/workflows/deploy.yml'

jobs:
  # Pre-deployment cleanup
  cleanup:
    runs-on: self-hosted
    steps:
      - name: Smart cleanup - Stop ALL related containers
        run: |
          echo "ğŸ§¹ Starting smart cleanup..."
          echo ""
          
          # Find and stop ALL containers with 'registration' in name
          echo "ğŸ” Finding all registration containers..."
          CONTAINERS=$(docker ps -a --filter "name=registration" --format "{{.Names}}" | tr '\n' ' ')
          
          if [ -z "$CONTAINERS" ]; then
            echo "âœ… No old containers found. Clean slate!"
          else
            echo "Found containers: $CONTAINERS"
            echo "ğŸ›‘ Stopping and removing..."
            
            for container in $CONTAINERS; do
              echo "  - Stopping $container..."
              docker stop $container || true
              echo "  - Removing $container..."
              docker rm $container || true
            done
            
            echo "âœ… All old containers cleaned up"
          fi
          echo ""
          
      - name: Check port availability
        run: |
          echo "ğŸ” Checking port availability..."
          echo ""
          
          for port in 8501 8502 8503 8504 8505; do
            if lsof -Pi :$port -sTCP:LISTEN -t >/dev/null 2>&1 ; then
              echo "âš ï¸  Port $port is in use"
              PID=$(lsof -Pi :$port -sTCP:LISTEN -t)
              echo "   Process ID: $PID"
            else
              echo "âœ… Port $port is available"
            fi
          done
          echo ""
          
      - name: Cleanup old images (optional)
        run: |
          echo "ğŸ§¹ Cleaning up old dangling images..."
          docker image prune -f || true
          echo "âœ… Cleanup complete"

  # Build SINGLE image
  build:
    runs-on: self-hosted
    needs: cleanup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run validation tests
        working-directory: ./Streamlit_app
        run: |
          echo "ğŸ§ª Running validation tests..."
          python3 tests/test_validation.py
          echo "âœ… Tests passed"
      
      - name: Build Docker image (ONCE)
        working-directory: ./Streamlit_app
        run: |
          echo "ğŸ”¨ Building SINGLE image: registration-app:latest"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          docker build -t registration-app:latest .
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Image built successfully"
          echo ""
          echo "ğŸ“¦ Image details:"
          docker images registration-app:latest

  # Deploy all 5 containers from SINGLE image
  deploy:
    runs-on: self-hosted
    needs: build
    steps:
      - name: Deploy Instance 1 on port 8501
        run: |
          echo "ğŸš€ Deploying Instance 1..."
          docker run -d \
            -p 8501:8501 \
            --name registration-instance-1 \
            --restart unless-stopped \
            registration-app:latest
          
          sleep 3
          
          if docker ps | grep -q registration-instance-1; then
            echo "âœ… Instance 1 started successfully on port 8501"
          else
            echo "âŒ Instance 1 failed to start"
            docker logs registration-instance-1
            exit 1
          fi
          echo ""
      
      - name: Deploy Instance 2 on port 8502
        run: |
          echo "ğŸš€ Deploying Instance 2..."
          docker run -d \
            -p 8502:8501 \
            --name registration-instance-2 \
            --restart unless-stopped \
            registration-app:latest
          
          sleep 3
          
          if docker ps | grep -q registration-instance-2; then
            echo "âœ… Instance 2 started successfully on port 8502"
          else
            echo "âŒ Instance 2 failed to start"
            docker logs registration-instance-2
            exit 1
          fi
          echo ""
      
      - name: Deploy Instance 3 on port 8503
        run: |
          echo "ğŸš€ Deploying Instance 3..."
          docker run -d \
            -p 8503:8501 \
            --name registration-instance-3 \
            --restart unless-stopped \
            registration-app:latest
          
          sleep 3
          
          if docker ps | grep -q registration-instance-3; then
            echo "âœ… Instance 3 started successfully on port 8503"
          else
            echo "âŒ Instance 3 failed to start"
            docker logs registration-instance-3
            exit 1
          fi
          echo ""
      
      - name: Deploy Instance 4 on port 8504
        run: |
          echo "ğŸš€ Deploying Instance 4..."
          docker run -d \
            -p 8504:8501 \
            --name registration-instance-4 \
            --restart unless-stopped \
            registration-app:latest
          
          sleep 3
          
          if docker ps | grep -q registration-instance-4; then
            echo "âœ… Instance 4 started successfully on port 8504"
          else
            echo "âŒ Instance 4 failed to start"
            docker logs registration-instance-4
            exit 1
          fi
          echo ""
      
      - name: Deploy Instance 5 on port 8505
        run: |
          echo "ğŸš€ Deploying Instance 5..."
          docker run -d \
            -p 8505:8501 \
            --name registration-instance-5 \
            --restart unless-stopped \
            registration-app:latest
          
          sleep 3
          
          if docker ps | grep -q registration-instance-5; then
            echo "âœ… Instance 5 started successfully on port 8505"
          else
            echo "âŒ Instance 5 failed to start"
            docker logs registration-instance-5
            exit 1
          fi
          echo ""
      
      - name: Health check all instances
        run: |
          echo "ğŸ¥ Running health checks on all instances..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          # Check Instance 1
          echo "Checking Instance 1 (port 8501)..."
          sleep 2
          if curl -f http://localhost:8501 >/dev/null 2>&1; then
            echo "âœ… Instance 1 healthy"
          else
            echo "âŒ Instance 1 health check failed"
            exit 1
          fi
          echo ""
          
          # Check Instance 2
          echo "Checking Instance 2 (port 8502)..."
          sleep 2
          if curl -f http://localhost:8502 >/dev/null 2>&1; then
            echo "âœ… Instance 2 healthy"
          else
            echo "âŒ Instance 2 health check failed"
            exit 1
          fi
          echo ""
          
          # Check Instance 3
          echo "Checking Instance 3 (port 8503)..."
          sleep 2
          if curl -f http://localhost:8503 >/dev/null 2>&1; then
            echo "âœ… Instance 3 healthy"
          else
            echo "âŒ Instance 3 health check failed"
            exit 1
          fi
          echo ""
          
          # Check Instance 4
          echo "Checking Instance 4 (port 8504)..."
          sleep 2
          if curl -f http://localhost:8504 >/dev/null 2>&1; then
            echo "âœ… Instance 4 healthy"
          else
            echo "âŒ Instance 4 health check failed"
            exit 1
          fi
          echo ""
          
          # Check Instance 5
          echo "Checking Instance 5 (port 8505)..."
          sleep 2
          if curl -f http://localhost:8505 >/dev/null 2>&1; then
            echo "âœ… Instance 5 healthy"
          else
            echo "âŒ Instance 5 health check failed"
            exit 1
          fi
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… All health checks passed!"

  # Deployment Summary
  deployment-summary:
    runs-on: self-hosted
    needs: [build, deploy]
    steps:
      - name: Display deployment summary
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… ALL 5 INSTANCES DEPLOYED SUCCESSFULLY!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ³ Docker Image (SINGLE IMAGE):"
          docker images | grep registration-app
          echo ""
          echo "ğŸ“¦ Running Containers (5 from same image):"
          docker ps --filter name=registration-instance --format "table {{.Names}}\t{{.Image}}\t{{.Status}}\t{{.Ports}}"
          echo ""
          echo "ğŸŒ Access URLs:"
          echo "   Instance 1 (Customer A): http://207.180.253.183:8501"
          echo "   Instance 2 (Customer B): http://207.180.253.183:8502"
          echo "   Instance 3 (Customer C): http://207.180.253.183:8503"
          echo "   Instance 4 (Customer D): http://207.180.253.183:8504"
          echo "   Instance 5 (Customer E): http://207.180.253.183:8505"
          echo ""
          echo "ğŸ’¾ Disk Space: ~450 MB (1 image instead of 5)"
          echo "â±ï¸  Build Time: ~56 seconds (instead of 280 seconds)"
          echo "ğŸ’° Cost Savings: ~75% less build time"
          echo ""
          echo "â±ï¸  Deployment completed at: $(date)"
