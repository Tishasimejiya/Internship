name: 'Health Check'
description: 'Verifies all instances are running and responding'

inputs:
  instances:
    description: 'JSON array of instances to check'
    required: true

runs:
  using: "composite"
  steps:
    - name: Run health checks
      shell: bash
      env:
        INSTANCES: ${{ inputs.instances }}
      run: |
        echo "ğŸ¥ Running health checks on all instances..."
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        
        HEALTHY=0
        UNHEALTHY=0
        
        # Count total instances
        COUNT=$(echo "$INSTANCES" | grep -o '"name"' | wc -l)
        
        # Loop through each instance
        for i in $(seq 1 $COUNT); do
          NAME=$(echo "$INSTANCES" | grep -o '"name":"[^"]*"' | sed -n "${i}p" | cut -d'"' -f4)
          PORT=$(echo "$INSTANCES" | grep -o '"port":[0-9]*' | sed -n "${i}p" | cut -d':' -f2)
          
          echo "Checking $NAME on port $PORT..."
          
          sleep 2
          
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:$PORT 2>/dev/null || echo "000")
          
          if [ "$RESPONSE" = "200" ] || [ "$RESPONSE" = "302" ]; then
            echo "âœ… $NAME is healthy (HTTP $RESPONSE)"
            HEALTHY=$((HEALTHY + 1))
          else
            echo "âŒ $NAME is unhealthy (HTTP $RESPONSE)"
            echo ""
            echo "ğŸ“‹ Recent logs from $NAME:"
            docker logs $NAME --tail 30 2>&1
            echo ""
            UNHEALTHY=$((UNHEALTHY + 1))
          fi
          
          echo ""
        done
        
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "Health Check Summary:"
        echo "  âœ… Healthy: $HEALTHY"
        echo "  âŒ Unhealthy: $UNHEALTHY"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        if [ $UNHEALTHY -gt 0 ]; then
          echo ""
          echo "âŒ Health check failed for one or more instances"
          exit 1
        fi
        
        echo ""
        echo "âœ… All instances are healthy!"
