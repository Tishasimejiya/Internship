name: 'Deploy Instances'
description: 'Deploys all registration containers with database connection'

inputs:
  instances:
    description: 'JSON array of instances to deploy'
    required: true
  db_host:
    description: 'Database host'
    required: true
  db_port:
    description: 'Database port'
    required: true
  db_name:
    description: 'Database name'
    required: true
  db_user:
    description: 'Database user'
    required: true
  db_password:
    description: 'Database password'
    required: true

runs:
  using: "composite"
  steps:
    - name: Deploy all instances
      shell: bash
      env:
        INSTANCES: ${{ inputs.instances }}
        DB_HOST: ${{ inputs.db_host }}
        DB_PORT: ${{ inputs.db_port }}
        DB_NAME: ${{ inputs.db_name }}
        DB_USER: ${{ inputs.db_user }}
        DB_PASSWORD: ${{ inputs.db_password }}
      run: |
        echo "ğŸš€ Deploying all instances..."
        echo ""
        
        # Count total instances
        COUNT=$(echo "$INSTANCES" | grep -o '"name"' | wc -l)
        echo "Found $COUNT instances to deploy"
        echo ""
        
        # Loop through each instance
        for i in $(seq 1 $COUNT); do
          # Extract values using grep and sed (no jq needed)
          NAME=$(echo "$INSTANCES" | grep -o '"name":"[^"]*"' | sed -n "${i}p" | cut -d'"' -f4)
          PORT=$(echo "$INSTANCES" | grep -o '"port":[0-9]*' | sed -n "${i}p" | cut -d':' -f2)
          NUM=$(echo "$INSTANCES" | grep -o '"num":[0-9]*' | sed -n "${i}p" | cut -d':' -f2)
          VOLUME="registration-uploads-instance-$NUM"
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Deploying: $NAME"
          echo "  Port: $PORT (host) â†’ 8501 (container)"
          echo "  Volume: $VOLUME"
          echo "  Database: $DB_HOST:$DB_PORT/$DB_NAME"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          docker run -d \
            -p $PORT:8501 \
            --name $NAME \
            --network app-network \
            -v $VOLUME:/app/Frontend/uploads \
            -e DB_HOST=$DB_HOST \
            -e DB_PORT=$DB_PORT \
            -e DB_NAME=$DB_NAME \
            -e DB_USER=$DB_USER \
            -e DB_PASSWORD=$DB_PASSWORD \
            --restart unless-stopped \
            registration-app:latest
          
          sleep 3
          
          if docker ps | grep -q $NAME; then
            echo "âœ… $NAME started successfully"
            echo "   Container ID: $(docker ps -q -f name=$NAME)"
          else
            echo "âŒ $NAME failed to start"
            echo ""
            echo "ğŸ“‹ Container logs:"
            docker logs $NAME 2>&1 | tail -20
            echo ""
            echo "ğŸ” Port check:"
            lsof -i :$PORT 2>/dev/null || echo "Port $PORT is available"
            exit 1
          fi
          
          echo ""
        done
        
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ… All $COUNT instances deployed successfully!"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
