name: 'Deploy Instances'
description: 'Deploys all registration containers with database connection'

inputs:
  instances:
    description: 'JSON array of instances to deploy'
    required: true
  db_host:
    description: 'Database host'
    required: true
  db_port:
    description: 'Database port'
    required: true
  db_name:
    description: 'Database name'
    required: true
  db_user:
    description: 'Database user'
    required: true
  db_password:
    description: 'Database password'
    required: true

runs:
  using: "composite"
  steps:
    - name: Deploy all instances
      shell: bash
      env:
        INSTANCES: ${{ inputs.instances }}
        DB_HOST: ${{ inputs.db_host }}
        DB_PORT: ${{ inputs.db_port }}
        DB_NAME: ${{ inputs.db_name }}
        DB_USER: ${{ inputs.db_user }}
        DB_PASSWORD: ${{ inputs.db_password }}
      run: |
        echo "ğŸš€ Deploying all instances..."
        echo ""
        
        COUNT=$(echo "$INSTANCES" | grep -o '"name"' | wc -l)
        echo "Found $COUNT instances to deploy"
        echo ""
        
        for i in $(seq 1 $COUNT); do
          NAME=$(echo "$INSTANCES" | grep -o '"name":"[^"]*"' | sed -n "${i}p" | cut -d'"' -f4)
          PORT=$(echo "$INSTANCES" | grep -o '"port":[0-9]*' | sed -n "${i}p" | cut -d':' -f2)
          NUM=$(echo "$INSTANCES" | grep -o '"num":[0-9]*' | sed -n "${i}p" | cut -d':' -f2)
          VOLUME="registration-uploads-instance-$NUM"
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Deploying: $NAME"
          echo "  Port: $PORT (host) â†’ 8501 (container)"
          echo "  Volume: $VOLUME"
          echo "  Database: $DB_HOST:$DB_PORT/$DB_NAME"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          CONTAINER_ID=$(docker run -d \
            -p $PORT:8501 \
            --name $NAME \
            --network app-network \
            -v $VOLUME:/app/Frontend/uploads \
            -e DB_HOST=$DB_HOST \
            -e DB_PORT=$DB_PORT \
            -e DB_NAME=$DB_NAME \
            -e DB_USER=$DB_USER \
            -e DB_PASSWORD=$DB_PASSWORD \
            --restart unless-stopped \
            registration-app:latest)
          
          echo "Container ID: $CONTAINER_ID"
          echo "Waiting for container to start..."
          sleep 5
          
          RUNNING=false
          for attempt in 1 2 3; do
            if docker ps --format "{{.Names}}" | grep -q "^${NAME}$"; then
              RUNNING=true
              break
            fi
            echo "  Attempt $attempt: Waiting for container..."
            sleep 2
          done
          
          if [ "$RUNNING" = "true" ]; then
            echo "âœ… $NAME started successfully"
          else
            echo "âš ï¸  $NAME check inconclusive (container may still be starting)"
            docker logs $NAME 2>&1 | tail -10
          fi
          
          echo ""
        done
        
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ… Deployment complete - $COUNT instances processed"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "ğŸ“Š Final status:"
        docker ps --filter "name=registration-instance-" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
        echo ""
        
        exit 0
