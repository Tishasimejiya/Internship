name: 'Cleanup Containers'
description: 'Stops and removes all registration containers'

inputs:
  instances:
    description: 'JSON array of instances'
    required: true

runs:
  using: "composite"
  steps:
    - name: Cleanup all containers
      shell: bash
      run: |
        echo "üßπ Starting cleanup of all registration containers..."
        echo ""
        
        CONTAINERS=$(docker ps -a --filter "name=registration-instance-" --format "{{.Names}}")
        
        if [ -z "$CONTAINERS" ]; then
          echo "‚úÖ No containers to cleanup. Clean slate!"
        else
          echo "Found containers to remove:"
          echo "$CONTAINERS"
          echo ""
          
          for container in $CONTAINERS; do
            echo "üõë Stopping $container..."
            docker stop $container 2>/dev/null || echo "  (already stopped)"
            
            echo "üóëÔ∏è  Removing $container..."
            docker rm $container 2>/dev/null || echo "  (already removed)"
            
            echo "‚úÖ $container cleaned up"
            echo ""
          done
          
          echo "‚úÖ All containers cleaned up successfully!"
        fi
        
        echo ""
        echo "üîç Checking port availability..."
        for port in 8501 8502 8503 8504 8505 8506 8507 8508 8509 8510; do
          if lsof -Pi :$port -sTCP:LISTEN -t >/dev/null 2>&1; then
            echo "‚ö†Ô∏è  Port $port is in use"
          else
            echo "‚úÖ Port $port is available"
          fi
        done
        echo ""
